<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Google Calendar Event Countdown</title>
    <style>
        /* [Your existing CSS styles go here] */
        /* ... */
    </style>
    <!-- Load Google API Client Library and Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
    <div class="input-container">
        <!-- [Your existing HTML content goes here] -->
        <!-- ... -->
        <!-- Google Sign-In Button -->
        <div id="g_id_onload"
             data-client_id="YOUR_CLIENT_ID.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-scope="https://www.googleapis.com/auth/calendar.readonly"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>

    <!-- Section to display event details -->
    <div class="event-details" id="eventDetails">
        No event loaded.
    </div>
    <p>2</p>
    <!-- Countdown Clock -->
    <div class="clock" id="clock">
        <!-- [Your existing clock HTML goes here] -->
        <!-- ... -->
    </div>

    <!-- Add sound element -->
    <!-- Replace with a valid sound file URL or host it locally -->
    <audio id="alarmSound" src="https://example.com/path-to-your-audio-file.wav"></audio>

    <script>
        let countdownInterval;
        const API_KEY = 'YOUR_API_KEY';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

        // Ensure the gapi client library is loaded
        function initializeGapiClient() {
            return new Promise((resolve) => {
                gapi.load('client', async function() {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: DISCOVERY_DOCS
                    });
                    resolve();
                });
            });
        }

        // Handle the response from Google Identity Services (GIS)
        async function handleCredentialResponse(response) {
            const token = response.credential; // Extract the credential token

            // Initialize Google API client using token
            await initializeGapiClient();

            // Set the authorization token
            gapi.client.setToken({ access_token: token });

            // Now list the upcoming events
            listUpcomingEvents();
        }

        // Fetch the next upcoming event and update the countdown
        function listUpcomingEvents() {
            gapi.client.calendar.events.list({
                'calendarId': 'primary', // Use 'primary' to access the user's primary calendar
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 1,
                'orderBy': 'startTime'
            }).then(function(response) {
                const events = response.result.items;
                const eventDetailsElement = document.getElementById('eventDetails');

                if (events.length > 0) {
                    const nextEvent = events[0];
                    const eventTitle = nextEvent.summary || 'No title';
                    const startTime = nextEvent.start.dateTime || nextEvent.start.date;

                    // Update event details
                    eventDetailsElement.innerHTML = `Next Event: <strong>${eventTitle}</strong> at <strong>${new Date(startTime).toLocaleString()}</strong>`;

                    // Update countdown input field with the next event's start time
                    const countdownInput = document.getElementById("countdownDate");
                    countdownInput.value = startTime.slice(0, 16);  // Format for input field

                    // Automatically start the countdown
                    startCountdown(new Date(startTime));
                } else {
                    eventDetailsElement.textContent = 'No upcoming events found.';
                }
            }).catch(function(error) {
                console.error('Error fetching events:', error);
                document.getElementById('eventDetails').textContent = 'Error fetching events: ' + error.result.error.message;
            });
        }

        // Start the countdown based on the event's start time
        function startCountdown(eventTime) {
            if (countdownInterval) clearInterval(countdownInterval); // Clear any existing countdown interval

            countdownInterval = setInterval(function() {
                const now = new Date().getTime();
                const distance = eventTime.getTime() - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById("alarmSound").play();
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById("days").textContent = days < 10 ? "0" + days : days;
                document.getElementById("hours").textContent = hours < 10 ? "0" + hours : hours;
                document.getElementById("minutes").textContent = minutes < 10 ? "0" + minutes : minutes;
                document.getElementById("seconds").textContent = seconds < 10 ? "0" + seconds : seconds;

            }, 1000); // Update every second
        }
    </script>
</body>
</html>
